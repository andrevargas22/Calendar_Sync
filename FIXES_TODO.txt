================================================================================
CALENDAR SYNC - LISTA DE CORRE√á√ïES PENDENTES
An√°lise realizada em: 27/02/2026
√öltima atualiza√ß√£o: 27/02/2026
================================================================================

================================================================================
üî¥ CORRE√á√ïES CR√çTICAS
================================================================================

‚è≥ [CR√çTICO-2] Poss√≠vel Inje√ß√£o via JSON de Credenciais
Arquivo: google_calendar.py (linha 31)
Problema: json.loads() sem valida√ß√£o de schema completa
Risco: Processamento de JSON malicioso se env var comprometida
Corre√ß√£o: Validar schema ap√≥s parsing + sanitizar exceptions com credenciais
C√≥digo afetado:
    credentials_info = json.loads(GOOGLE_SERVICE_ACCOUNT_KEY)


================================================================================
üü† CORRE√á√ïES DE ALTA PRIORIDADE
================================================================================

‚è≥ [ALTA-1] Falta Pagina√ß√£o na API do Google
Arquivo: google_calendar.py (linha 117)
Problema: maxResults=2500 sem loop de pagina√ß√£o
Impacto: Eventos al√©m do limite s√£o ignorados silenciosamente
Corre√ß√£o: Implementar pagina√ß√£o usando pageToken
C√≥digo afetado:
    maxResults=2500  # E se houver 3000 eventos?

‚è≥ [ALTA-3] TEAMS_ICS_URL N√£o Validada (Risco SSRF)
Arquivo: teams_functions.py (linha 26)
Problema: URL de env var usada diretamente em requests.get()
Risco: SSRF - pode apontar para servi√ßos internos
Corre√ß√£o: Validar URL (https://, n√£o IP privado, whitelist dom√≠nio)
C√≥digo afetado:
    resp = requests.get(TEAMS_ICS_URL, timeout=30, headers=headers)

‚è≥ [ALTA-4] N+1 Queries - Dele√ß√£o de Eventos Cancelados
Arquivo: calendar_sync.py (linhas 107-114)
Problema: Loop com chamada API individual para cada dele√ß√£o
Impacto: 50 cancelamentos = 50 API calls (lento + gasta quota)
Corre√ß√£o: Usar Google Calendar Batch API
C√≥digo afetado:
    for cancel_ev in cancelado_events:
        delete_google_event_by_id(...)

‚è≥ [ALTA-5] N+1 Queries - Cria√ß√£o de Eventos
Arquivo: calendar_sync.py (linhas 120-134)
Problema: Loop com chamada API individual para cada cria√ß√£o
Impacto: Performance ruim e gasto de quota
Corre√ß√£o: Usar Batch API (at√© 50 eventos por request)
C√≥digo afetado:
    for key, ev in teams_dict.items():
        create_google_event(...)

‚è≥ [ALTA-6] N+1 Queries - Dele√ß√£o de Eventos √ìrf√£os
Arquivo: calendar_sync.py (linhas 137-147)
Problema: Mesmo padr√£o N+1 para dele√ß√µes
Corre√ß√£o: Batch API

‚è≥ [ALTA-7] Fun√ß√£o normalize_event Complexa e Fr√°gil
Arquivo: calendar_sync.py (linhas 35-42)
Problema: L√≥gica condicional baseada em string, dif√≠cil testar
Corre√ß√£o: Separar em normalize_google_event() e normalize_teams_event()


================================================================================
üü° CORRE√á√ïES DE PRIORIDADE M√âDIA
================================================================================

‚è≥ [M√âDIA-1] Parsing Fr√°gil de Timezone
Arquivo: utils.py (linhas 23-24)
Problema: elif '-' in dtstr[11:] assume que √© timezone
Exemplo: "2024-01-15T10:00-05:00" pode ser cortado errado
Corre√ß√£o: Usar regex ou dateutil para parsing robusto

‚è≥ [M√âDIA-2] Eventos All-Day Viram Meia-Noite
Arquivo: teams_functions.py (linhas 44-46)
Problema: datetime.combine(s, datetime.min.time()) = 00:00:00
Impacto: Eventos de dia inteiro aparecem √†s 00:00
Corre√ß√£o: Detectar all-day e usar conven√ß√£o correta do Google Calendar

‚è≥ [M√âDIA-5] Timezone DST (Hor√°rio de Ver√£o)
Arquivo: utils.py, calendar_sync.py
Problema: replace(tzinfo=None) pode causar bugs em transi√ß√µes DST
Corre√ß√£o: Manter timezone aware datetimes no pipeline

‚è≥ [M√âDIA-6] Magic Numbers N√£o Configur√°veis
Arquivo: google_calendar.py (linhas 56-57)
Problema: max_attempts=4, base_delay=0.5 hard-coded
Corre√ß√£o: Mover para config.py

‚è≥ [M√âDIA-7] Duplica√ß√£o de C√≥digo em Logs
Arquivo: google_calendar.py (linhas 177-268)
Problema: Blocos if/else repetidos para LOG_MASK_TITLES
Corre√ß√£o: Criar helper log_with_mask(message, title=None)

‚è≥ [M√âDIA-8] Credenciais Podem Vazar em Logs de Erro
Arquivo: google_calendar.py (linhas 49-50)
Problema: Exceptions com dados sens√≠veis podem ser logadas
Corre√ß√£o: Sanitizar exceptions antes de logar

‚è≥ [M√âDIA-9] Retry com Sleep Bloqueia Thread
Arquivo: google_calendar.py (linha 70)
Problema: time.sleep(delay) bloqueia execu√ß√£o completa
Impacto: Script trava durante retries
Nota: Para CLI simples √© aceit√°vel, mas considerar async se escalar

‚è≥ [M√âDIA-10] Eventos Recorrentes com Exce√ß√µes
Problema: Inst√¢ncia cancelada de evento recorrente pode processar errado
Corre√ß√£o: Verificar RECURRENCE-ID em eventos iCal

‚è≥ [M√âDIA-11] Processamento Completo em Mem√≥ria
Arquivo: calendar_sync.py (linhas 88-147)
Problema: Carrega TODOS eventos em mem√≥ria
Impacto: Milhares de eventos = alto uso de mem√≥ria
Corre√ß√£o: Processar em streaming ou chunks

‚è≥ [M√âDIA-12] Inconsist√™ncia de Timezone Hard-coded
Arquivo: calendar_sync.py (linha 21)
Problema: LOCAL_TZ hard-coded, mas config.py tem TIMEZONE
Corre√ß√£o: Usar TIMEZONE do config
