================================================================================
CALENDAR SYNC - LISTA DE CORRE√á√ïES IDENTIFICADAS
An√°lise realizada em: 27/02/2026
================================================================================

================================================================================
üî¥ CORRE√á√ïES CR√çTICAS
================================================================================

[CR√çTICO-1] Colis√£o de Hash em Eventos Duplicados
Arquivo: calendar_sync.py (linhas 88-95)
Problema: Dicion√°rio sobrescreve eventos com mesma chave (t√≠tulo+hor√°rio)
Impacto: Perda silenciosa de eventos duplicados leg√≠timos
Corre√ß√£o: Adicionar UID do iCal √† chave ou usar estrutura de dados diferente
C√≥digo afetado:
    teams_dict[normalize_event(ev, 'teams')] = ev  # Sobrescreve!

[CR√çTICO-2] Poss√≠vel Inje√ß√£o via JSON de Credenciais
Arquivo: google_calendar.py (linha 31)
Problema: json.loads() sem valida√ß√£o de schema
Risco: Processamento de JSON malicioso se env var comprometida
Corre√ß√£o: Validar schema ap√≥s parsing (usar jsonschema)
C√≥digo afetado:
    credentials_info = json.loads(GOOGLE_SERVICE_ACCOUNT_KEY)


================================================================================
üü† CORRE√á√ïES DE ALTA PRIORIDADE
================================================================================

[ALTA-1] Falta Pagina√ß√£o na API do Google
Arquivo: google_calendar.py (linha 117)
Problema: maxResults=2500 sem loop de pagina√ß√£o
Impacto: Eventos al√©m do limite s√£o ignorados silenciosamente
Corre√ß√£o: Implementar pagina√ß√£o usando pageToken
C√≥digo afetado:
    maxResults=2500  # E se houver 3000 eventos?

[ALTA-2] Bug de C√°lculo para Domingos
Arquivo: utils.py (linha 50)
Problema: hoje.weekday() = 6 no domingo, pega semana anterior
Impacto: Em domingos sincroniza semana errada!
Corre√ß√£o: Ajustar c√°lculo considerando domingo
C√≥digo afetado:
    seg_atual = hoje - timedelta(days=hoje.weekday())

[ALTA-3] TEAMS_ICS_URL N√£o Validada (Risco SSRF)
Arquivo: teams_functions.py (linha 26)
Problema: URL de env var usada diretamente em requests.get()
Risco: SSRF - pode apontar para servi√ßos internos
Corre√ß√£o: Validar URL (https://, n√£o IP privado, whitelist dom√≠nio)
C√≥digo afetado:
    resp = requests.get(TEAMS_ICS_URL, timeout=30, headers=headers)

[ALTA-4] N+1 Queries - Dele√ß√£o de Eventos Cancelados
Arquivo: calendar_sync.py (linhas 107-114)
Problema: Loop com chamada API individual para cada dele√ß√£o
Impacto: 50 cancelamentos = 50 API calls (lento + gasta quota)
Corre√ß√£o: Usar Google Calendar Batch API
C√≥digo afetado:
    for cancel_ev in cancelado_events:
        remover_evento_google_by_id(...)

[ALTA-5] N+1 Queries - Cria√ß√£o de Eventos
Arquivo: calendar_sync.py (linhas 120-134)
Problema: Loop com chamada API individual para cada cria√ß√£o
Impacto: Performance ruim e gasto de quota
Corre√ß√£o: Usar Batch API (at√© 50 eventos por request)
C√≥digo afetado:
    for key, ev in teams_dict.items():
        criar_evento_google(...)

[ALTA-6] N+1 Queries - Dele√ß√£o de Eventos √ìrf√£os
Arquivo: calendar_sync.py (linhas 137-147)
Problema: Mesmo padr√£o N+1 para dele√ß√µes
Corre√ß√£o: Batch API
C√≥digo afetado:
    for key, g_ev in google_dict.items():
        remover_evento_google_by_id(...)

[ALTA-7] Fun√ß√£o normalize_event Complexa e Fr√°gil
Arquivo: calendar_sync.py (linhas 35-42)
Problema: L√≥gica condicional baseada em string, dif√≠cil testar
Corre√ß√£o: Separar em normalize_google_event() e normalize_teams_event()


================================================================================
üü° CORRE√á√ïES DE PRIORIDADE M√âDIA
================================================================================

[M√âDIA-1] Parsing Fr√°gil de Timezone
Arquivo: utils.py (linhas 23-24)
Problema: elif '-' in dtstr[11:] assume que √© timezone
Exemplo: "2024-01-15T10:00-05:00" pode ser cortado errado
Corre√ß√£o: Usar regex ou dateutil para parsing robusto

[M√âDIA-2] Eventos All-Day Viram Meia-Noite
Arquivo: teams_functions.py (linhas 44-46)
Problema: datetime.combine(s, datetime.min.time()) = 00:00:00
Impacto: Eventos de dia inteiro aparecem √†s 00:00
Corre√ß√£o: Detectar all-day e usar conven√ß√£o correta do Google Calendar

[M√âDIA-3] Dele√ß√£o Falha Silenciosamente
Arquivo: calendar_sync.py (linha 107)
Problema: g_ev.get('id', None) + fun√ß√£o retorna False = falha silenciosa
Impacto: Eventos cancelados n√£o removidos sem aviso
Corre√ß√£o: Validar ID antes ou logar erro expl√≠cito

[M√âDIA-4] Eventos que Mudam de Hor√°rio Criam Duplicatas
Arquivo: calendar_sync.py (linhas 88-147)
Problema: Script s√≥ cria/deleta, n√£o atualiza
Impacto: Mudan√ßa de hor√°rio cria novo evento sem deletar antigo
Corre√ß√£o: Implementar l√≥gica de UPDATE para eventos existentes

[M√âDIA-5] Timezone DST (Hor√°rio de Ver√£o)
Arquivo: utils.py, calendar_sync.py
Problema: replace(tzinfo=None) pode causar bugs em transi√ß√µes DST
Corre√ß√£o: Manter timezone aware datetimes no pipeline

[M√âDIA-6] Magic Numbers N√£o Configur√°veis
Arquivo: google_calendar.py (linhas 56-57)
Problema: max_attempts=4, base_delay=0.5 hard-coded
Corre√ß√£o: Mover para config.py

[M√âDIA-7] Duplica√ß√£o de C√≥digo em Logs
Arquivo: google_calendar.py (linhas 177-268)
Problema: Blocos if/else repetidos para LOG_MASK_TITLES
Corre√ß√£o: Criar helper log_with_mask(message, title=None)

[M√âDIA-8] Credenciais Podem Vazar em Logs de Erro
Arquivo: google_calendar.py (linhas 49-50)
Problema: Exceptions com dados sens√≠veis podem ser logadas
Corre√ß√£o: Sanitizar exceptions antes de logar

[M√âDIA-9] Retry com Sleep Bloqueia Thread
Arquivo: google_calendar.py (linha 70)
Problema: time.sleep(delay) bloqueia execu√ß√£o completa
Impacto: Script trava durante retries
Nota: Para CLI simples √© aceit√°vel, mas considerar async se escalar

[M√âDIA-10] Eventos Recorrentes com Exce√ß√µes
Problema: Inst√¢ncia cancelada de evento recorrente pode processar errado
Corre√ß√£o: Verificar RECURRENCE-ID em eventos iCal

[M√âDIA-11] Processamento Completo em Mem√≥ria
Arquivo: calendar_sync.py (linhas 88-147)
Problema: Carrega TODOS eventos em mem√≥ria
Impacto: Milhares de eventos = alto uso de mem√≥ria
Corre√ß√£o: Processar em streaming ou chunks

[M√âDIA-12] Inconsist√™ncia de Timezone Hard-coded
Arquivo: calendar_sync.py (linha 21)
Problema: LOCAL_TZ hard-coded, mas config.py tem TIMEZONE
Corre√ß√£o: Usar TIMEZONE do config


================================================================================
‚ö™ CORRE√á√ïES DE BAIXA PRIORIDADE
================================================================================

[BAIXA-1] Nomenclatura Inconsistente (PT/EN)
Arquivos: Todos
Problema: Mistura portugu√™s e ingl√™s
Exemplos: criar_evento_google, titulo, get_teams_events
Corre√ß√£o: Padronizar tudo em ingl√™s

[BAIXA-2] Falta de Type Hints
Arquivos: Todos exceto partes de config.py
Problema: Dificulta IDE autocomplete e detec√ß√£o de erros
Corre√ß√£o: Adicionar type hints em todas as fun√ß√µes

[BAIXA-3] Sem Rate Limiting
Arquivos: Todas chamadas de API
Problema: Sem limite de requisi√ß√µes
Corre√ß√£o: Implementar rate limiting ou circuit breaker

[BAIXA-4] Eventos com Dura√ß√£o Zero
Problema: Se inicio == fim, pode causar erro na API Google
Corre√ß√£o: Validar e rejeitar eventos com dura√ß√£o zero

[BAIXA-5] T√≠tulo Vazio ou None
Arquivo: calendar_sync.py (linha 36)
Problema: event['titulo'].strip() assume que titulo existe
Corre√ß√£o: Adicionar null check: (event.get('titulo') or '').strip()

[BAIXA-6] Falta Tratamento para Status HTTP Espec√≠ficos
Arquivo: teams_functions.py
Problema: Apenas raise_for_status() gen√©rico
Corre√ß√£o: Tratar 401, 403, 404 com mensagens espec√≠ficas

[BAIXA-7] Logger Setup Pode Criar M√∫ltiplas Inst√¢ncias
Arquivo: logger.py
Problema: Se importado de lugares diferentes pode ter behavior inesperado
Nota: Atual verifica handlers, mas pode melhorar

[BAIXA-8] Falta Valida√ß√£o de DAYS_RANGE
Arquivo: config.py
Problema: DAYS_RANGE pode ser negativo ou muito grande
Corre√ß√£o: Validar range razo√°vel (1-365)


================================================================================
üéØ PLANO DE IMPLEMENTA√á√ÉO SUGERIDO
================================================================================

FASE 1 - CORRE√á√ïES CR√çTICAS E DE SEGURAN√áA
- [CR√çTICO-1] Colis√£o de hash
- [CR√çTICO-2] Valida√ß√£o JSON
- [ALTA-3] Valida√ß√£o SSRF

FASE 2 - BUGS QUE AFETAM FUNCIONAMENTO
- [ALTA-2] Bug do domingo
- [M√âDIA-3] Dele√ß√£o silenciosa
- [M√âDIA-4] Eventos que mudam hor√°rio

FASE 3 - PERFORMANCE
- [ALTA-1] Pagina√ß√£o Google API
- [ALTA-4] Batch API dele√ß√£o cancelados
- [ALTA-5] Batch API cria√ß√£o
- [ALTA-6] Batch API dele√ß√£o √≥rf√£os

FASE 4 - MANUTENIBILIDADE
- [ALTA-7] Refactor normalize_event
- [M√âDIA-7] Helper para logs
- [BAIXA-2] Type hints
- [BAIXA-1] Nomenclatura

FASE 5 - CASOS EDGE E MELHORIAS
- [M√âDIA-1] Parsing timezone robusto
- [M√âDIA-2] All-day events
- [M√âDIA-5] Timezone DST
- [M√âDIA-10] Eventos recorrentes


================================================================================
üìä ESTAT√çSTICAS
================================================================================

Total de problemas identificados: 29
- Cr√≠ticos: 2
- Alta prioridade: 7
- M√©dia prioridade: 12
- Baixa prioridade: 8

Arquivos afetados:
- calendar_sync.py: 11 issues
- google_calendar.py: 9 issues
- utils.py: 4 issues
- teams_functions.py: 3 issues
- config.py: 2 issues

================================================================================
FIM DO DOCUMENTO
================================================================================
